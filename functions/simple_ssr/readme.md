# SSR + ER = ESR

**React SSR 跑在 ER 上的测试 demo，由 esa cli 使用 esbuild 打包。**

**根目录需要有 esa.toml 文件（目前没有配置项也能跑），用来配置项目信息，标记这是一个 esa 项目。**

**这个例子提供了一种\*\***完全在一个目录，通过 cli，完成前端开发、er 开发过程的方案\*\*。

## 项目介绍

**项目分两部分，\*\***er 代码** 和 **客户端代码\*\*。

# ⚠️ 注意：目前该项目只能在付费模式下时间片选择 100ms 部署后才能在线上运行

### er 代码

**ER 代码的入口文件是 **`sr/index.js`，支持所有 EdgeWorker 语法，支持模块化，在上传和 build 时会进行打包。

### 客户端代码

**客户端代码不限于在这里，可以放在任何地方，可以自行写打包配置，这里使用了 webpack 做例子；最后将水合代码接入到 html 模板中即可。**

## 运行

1. **安装 esa cli，安装依赖**

```
tnpm i -g esa-cli # 目前还没发布，到时候这么安装
tnpm i
```

2. **打包客户端代码**

```
tnpm run build
```

3. **启动 er 本地 dev，根据显示操作即可。dev 期间会检测本地代码变化，自动编译代码（客户端代码需要手动打包）**

```
esa dev
```

4. **打包发布**

```
esa commit
```

## SSR 实现原理

1. **客户端入口需要做\*\***水合(hydrateRoot)\*\*，这样生成的客户端代码包含了事件和业务逻辑，可以接管服务端通过 renderToString 生成的 html 模板。
2. **通过 BrowserRouter 实现路由跳转。**
3. **通过 Outlet 将页面输出到指定位置，可以用来实现 layout。**
4. **服务端通过 renderToString 生成 html 骨架代码，输出到 html 模板中。**
5. **将客户端生成的代码通过 script src 或者直接当作字符串插入到 html 模板中。**
